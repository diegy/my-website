<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæç¤ºè¯ç”Ÿæˆå™¨ - è®©AIæ›´æ‡‚ä½ çš„éœ€æ±‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
        .tag-selected { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .history-item:hover { transform: translateX(5px); }
        .metric-card { transition: all 0.3s ease; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">è®¾ç½® Claude API Key</h2>
            <p class="text-gray-600 mb-6">è¯·è¾“å…¥ä½ çš„ Anthropic API Key ä»¥ä½¿ç”¨æç¤ºè¯ç”ŸæˆåŠŸèƒ½ã€‚å¯†é’¥ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-..." 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-4">
            <button onclick="saveApiKey()" class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition">
                ä¿å­˜å¹¶å¼€å§‹ä½¿ç”¨
            </button>
            <p class="text-xs text-gray-500 mt-4 text-center">
                æ²¡æœ‰ API Keyï¼Ÿ<a href="https://console.anthropic.com/" target="_blank" class="text-purple-600 hover:underline">å‰å¾€ Anthropic æ§åˆ¶å°è·å–</a>
            </p>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">AIæç¤ºè¯ç”Ÿæˆå™¨</h1>
                    <p class="text-sm text-white text-opacity-80">è®©æ¨¡ç³Šæƒ³æ³•å˜æˆç²¾å‡†æŒ‡ä»¤</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showApiKeyModal()" class="text-sm bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition">
                    æ›´æ¢ API Key
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 flex gap-6">
        <!-- Left Sidebar: Evolution Tracking -->
        <aside class="w-80 hidden lg:block">
            <div class="glass-effect rounded-2xl p-6 shadow-lg sticky top-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800">æç¤ºè¯è¿›åŒ–è¿½è¸ª</h2>
                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">P1åŠŸèƒ½</span>
                </div>
                
                <!-- User Growth Stats -->
                <div class="mb-6 space-y-3">
                    <div class="metric-card bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">ç”Ÿæˆæ¬¡æ•°</p>
                        <p class="text-2xl font-bold text-purple-700" id="totalGenerations">0</p>
                    </div>
                    <div class="metric-card bg-gradient-to-r from-green-50 to-teal-50 p-4 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">å¹³å‡æ»¡æ„åº¦</p>
                        <p class="text-2xl font-bold text-green-700" id="avgSatisfaction">--</p>
                    </div>
                    <div class="metric-card bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-xl">
                        <p class="text-xs text-gray-600 mb-1">æœ€çˆ±åœºæ™¯</p>
                        <p class="text-lg font-bold text-orange-700" id="favoriteScene">--</p>
                    </div>
                </div>

                <!-- Evolution History -->
                <div class="border-t pt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">æœ€è¿‘ä¼˜åŒ–è®°å½•</h3>
                    <div id="evolutionList" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-500 text-center py-4">æš‚æ— è®°å½•ï¼Œå¼€å§‹ç”Ÿæˆä½ çš„ç¬¬ä¸€ä¸ªæç¤ºè¯å§ï¼</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Main Generator -->
        <main class="flex-1 max-w-3xl">
            <!-- Scene Tag Selection (P0: Intent-Scene Tagging System) -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">é€‰æ‹©ä½¿ç”¨åœºæ™¯</h2>
                    <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-medium">P0å¿…å¡«</span>
                </div>
                <p class="text-sm text-gray-600 mb-4">é€‰æ‹©åœºæ™¯å¯å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆæ›´ç²¾å‡†çš„æç¤ºè¯ï¼Œå¹¶ä¸ºä½ æ„å»ºä¸ªæ€§åŒ–æ¨èã€‚</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="sceneTags">
                    <button onclick="toggleScene(this, 'work-report')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="work-report">
                        <div class="text-2xl mb-1">ğŸ’¼</div>
                        <div class="text-sm font-medium">å·¥ä½œæ±‡æŠ¥</div>
                    </button>
                    <button onclick="toggleScene(this, 'creative-writing')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="creative-writing">
                        <div class="text-2xl mb-1">âœï¸</div>
                        <div class="text-sm font-medium">åˆ›æ„å†™ä½œ</div>
                    </button>
                    <button onclick="toggleScene(this, 'code-explain')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="code-explain">
                        <div class="text-2xl mb-1">ğŸ’»</div>
                        <div class="text-sm font-medium">ä»£ç è§£é‡Š</div>
                    </button>
                    <button onclick="toggleScene(this, 'data-analysis')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="data-analysis">
                        <div class="text-2xl mb-1">ğŸ“Š</div>
                        <div class="text-sm font-medium">æ•°æ®åˆ†æ</div>
                    </button>
                    <button onclick="toggleScene(this, 'learning')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="learning">
                        <div class="text-2xl mb-1">ğŸ“š</div>
                        <div class="text-sm font-medium">å­¦ä¹ è¾…å¯¼</div>
                    </button>
                    <button onclick="toggleScene(this, 'translation')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="translation">
                        <div class="text-2xl mb-1">ğŸŒ</div>
                        <div class="text-sm font-medium">ç¿»è¯‘æ¶¦è‰²</div>
                    </button>
                    <button onclick="toggleScene(this, 'meeting')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="meeting">
                        <div class="text-2xl mb-1">ğŸ¤</div>
                        <div class="text-sm font-medium">ä¼šè®®è¾…åŠ©</div>
                    </button>
                    <button onclick="toggleScene(this, 'other')" class="scene-tag border-2 border-gray-200 rounded-xl p-3 text-center hover:border-purple-400 transition" data-scene="other">
                        <div class="text-2xl mb-1">ğŸ¯</div>
                        <div class="text-sm font-medium">å…¶ä»–åœºæ™¯</div>
                    </button>
                </div>
                
                <!-- Selected tags display -->
                <div id="selectedScenesDisplay" class="mt-4 flex flex-wrap gap-2 hidden">
                    <span class="text-sm text-gray-600 mr-2">å·²é€‰æ‹©ï¼š</span>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">æè¿°ä½ çš„éœ€æ±‚</h2>
                <textarea id="userInput" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è®©AIå¸®æˆ‘å†™ä¸€ä»½å‘¨æŠ¥ï¼Œæ€»ç»“è¿™å‘¨å®Œæˆçš„é¡¹ç›®è¿›åº¦å’Œé‡åˆ°çš„é—®é¢˜..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none resize-none text-gray-700"></textarea>
                
                <!-- Intent Analysis Preview -->
                <div id="intentPreview" class="mt-4 p-4 bg-blue-50 rounded-xl hidden fade-in">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm font-medium text-blue-800">æ„å›¾è¯†åˆ«</span>
                    </div>
                    <p class="text-sm text-blue-700" id="intentText">æ£€æµ‹åˆ°ä½ çš„æ„å›¾æ˜¯...</p>
                </div>

                <button onclick="generatePrompt()" id="generateBtn" 
                    class="w-full mt-4 gradient-bg text-white py-4 rounded-xl font-medium text-lg hover:opacity-90 transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>ç”Ÿæˆç»“æ„åŒ–æç¤ºè¯</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="bg-white rounded-2xl shadow-lg p-12 text-center hidden">
                <div class="animate-spin w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">æ­£åœ¨åˆ†æä½ çš„éœ€æ±‚å¹¶ç”Ÿæˆä¼˜åŒ–åçš„æç¤ºè¯...</p>
                <p class="text-sm text-gray-400 mt-2" id="loadingStep">æ­¥éª¤ 1/3: åˆ†ææ„å›¾åœºæ™¯</p>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="bg-white rounded-2xl shadow-lg p-6 hidden fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">ç”Ÿæˆçš„æç¤ºè¯</h2>
                    <div class="flex space-x-2">
                        <button onclick="copyResult()" class="text-sm text-gray-600 hover:text-purple-600 flex items-center space-x-1 px-3 py-1 rounded-lg hover:bg-purple-50 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span>å¤åˆ¶</span>
                        </button>
                        <button onclick="regeneratePrompt()" class="text-sm text-gray-600 hover:text-purple-600 flex items-center space-x-1 px-3 py-1 rounded-lg hover:bg-purple-50 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>é‡æ–°ç”Ÿæˆ</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-900 rounded-xl p-4 overflow-x-auto">
                    <pre id="generatedPrompt" class="text-green-400 text-sm whitespace-pre-wrap font-mono typing-cursor"></pre>
                </div>

                <!-- Usage Tips -->
                <div class="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-yellow-800">ä½¿ç”¨å»ºè®®</p>
                            <p class="text-sm text-yellow-700 mt-1">ç›´æ¥å¤åˆ¶ä¸Šæ–¹æç¤ºè¯åˆ° Claude æˆ–å…¶ä»– AI å¯¹è¯ä¸­ä½¿ç”¨ã€‚ä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ [æ–¹æ‹¬å·] ä¸­çš„å†…å®¹ã€‚</p>
                        </div>
                    </div>
                </div>

                <!-- Feedback Section (P0: Effect Feedback Loop) -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-medium text-gray-800">è¿™ä¸ªæç¤ºè¯å¥½ç”¨å—ï¼Ÿ</h3>
                            <p class="text-sm text-gray-500">ä½ çš„åé¦ˆå°†å¸®åŠ©æˆ‘ä»¬æŒç»­ä¼˜åŒ–ç”Ÿæˆè´¨é‡</p>
                        </div>
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">P0åé¦ˆé—­ç¯</span>
                    </div>
                    
                    <div id="feedbackButtons" class="flex space-x-4">
                        <button onclick="submitFeedback('up')" class="flex-1 py-3 border-2 border-gray-200 rounded-xl hover:border-green-400 hover:bg-green-50 transition flex items-center justify-center space-x-2 group">
                            <svg class="w-6 h-6 text-gray-400 group-hover:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                            </svg>
                            <span class="text-gray-600 group-hover:text-green-600">å¥½ç”¨</span>
                        </button>
                        <button onclick="submitFeedback('down')" class="flex-1 py-3 border-2 border-gray-200 rounded-xl hover:border-red-400 hover:bg-red-50 transition flex items-center justify-center space-x-2 group">
                            <svg class="w-6 h-6 text-gray-400 group-hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
                            </svg>
                            <span class="text-gray-600 group-hover:text-red-600">éœ€è¦æ”¹è¿›</span>
                        </button>
                    </div>

                    <!-- Feedback Detail Input -->
                    <div id="feedbackDetail" class="mt-4 hidden fade-in">
                        <textarea id="feedbackText" rows="3" placeholder="è¯·è¯¦ç»†è¯´æ˜åŸå› ï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›ï¼ˆå¯é€‰ï¼‰..." 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none resize-none text-sm"></textarea>
                        <button onclick="submitFeedbackDetail()" class="mt-2 bg-purple-600 text-white px-6 py-2 rounded-lg text-sm hover:bg-purple-700 transition">
                            æäº¤åé¦ˆ
                        </button>
                    </div>

                    <!-- Feedback Success Message -->
                    <div id="feedbackSuccess" class="mt-4 p-4 bg-green-50 rounded-xl hidden">
                        <p class="text-sm text-green-700 text-center">æ„Ÿè°¢ä½ çš„åé¦ˆï¼æˆ‘ä»¬ä¼šç”¨å®ƒæ¥ä¼˜åŒ–ç”Ÿæˆè´¨é‡ã€‚</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Application State
        const state = {
            apiKey: localStorage.getItem('claude_api_key') || '',
            selectedScenes: [],
            currentGeneration: null,
            generationHistory: JSON.parse(localStorage.getItem('generation_history') || '[]'),
            feedbackData: JSON.parse(localStorage.getItem('feedback_data') || '[]'),
            isGenerating: false
        };

        // Scene configurations with system prompts
        const sceneConfigs = {
            'work-report': {
                name: 'å·¥ä½œæ±‡æŠ¥',
                icon: 'ğŸ’¼',
                description: 'ç”Ÿæˆç»“æ„åŒ–å·¥ä½œæ±‡æŠ¥ã€å‘¨æŠ¥ã€æœˆæŠ¥ç­‰'
            },
            'creative-writing': {
                name: 'åˆ›æ„å†™ä½œ',
                icon: 'âœï¸',
                description: 'è¾…åŠ©å°è¯´ã€æ–‡ç« ã€å‰§æœ¬ç­‰åˆ›æ„å†…å®¹åˆ›ä½œ'
            },
            'code-explain': {
                name: 'ä»£ç è§£é‡Š',
                icon: 'ğŸ’»',
                description: 'è§£é‡Šä»£ç é€»è¾‘ã€ç”Ÿæˆæ³¨é‡Šã€è°ƒè¯•å¸®åŠ©'
            },
            'data-analysis': {
                name: 'æ•°æ®åˆ†æ',
                icon: 'ğŸ“Š',
                description: 'åˆ†ææ•°æ®ã€ç”Ÿæˆå›¾è¡¨ã€ä¸šåŠ¡æ´å¯Ÿ'
            },
            'learning': {
                name: 'å­¦ä¹ è¾…å¯¼',
                icon: 'ğŸ“š',
                description: 'çŸ¥è¯†ç‚¹è®²è§£ã€ä¹ é¢˜è§£ç­”ã€å­¦ä¹ è®¡åˆ’'
            },
            'translation': {
                name: 'ç¿»è¯‘æ¶¦è‰²',
                icon: 'ğŸŒ',
                description: 'å¤šè¯­è¨€ç¿»è¯‘ã€æ–‡æœ¬æ¶¦è‰²ã€è¯­æ³•æ£€æŸ¥'
            },
            'meeting': {
                name: 'ä¼šè®®è¾…åŠ©',
                icon: 'ğŸ¤',
                description: 'ä¼šè®®çºªè¦ã€è®®ç¨‹å®‰æ’ã€è®¨è®ºæ€»ç»“'
            },
            'other': {
                name: 'å…¶ä»–åœºæ™¯',
                icon: 'ğŸ¯',
                description: 'é€šç”¨åœºæ™¯ï¼Œçµæ´»é€‚é…å„ç§éœ€æ±‚'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!state.apiKey) {
                showApiKeyModal();
            }
            updateEvolutionDisplay();
            updateStats();
        });

        // API Key Management
        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            document.getElementById('apiKeyInput').value = state.apiKey;
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key.startsWith('sk-ant-')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Anthropic API Keyï¼ˆä»¥ sk-ant- å¼€å¤´ï¼‰');
                return;
            }
            state.apiKey = key;
            localStorage.setItem('claude_api_key', key);
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        // Scene Tag Selection (P0: Intent-Scene Tagging System)
        function toggleScene(element, scene) {
            if (state.selectedScenes.includes(scene)) {
                state.selectedScenes = state.selectedScenes.filter(s => s !== scene);
                element.classList.remove('tag-selected', 'border-purple-500');
                element.classList.add('border-gray-200');
            } else {
                state.selectedScenes.push(scene);
                element.classList.add('tag-selected', 'border-purple-500');
                element.classList.remove('border-gray-200');
            }
            updateSelectedScenesDisplay();
        }

        function updateSelectedScenesDisplay() {
            const display = document.getElementById('selectedScenesDisplay');
            if (state.selectedScenes.length === 0) {
                display.classList.add('hidden');
                return;
            }
            display.classList.remove('hidden');
            display.innerHTML = '<span class="text-sm text-gray-600 mr-2">å·²é€‰æ‹©ï¼š</span>';
            state.selectedScenes.forEach(scene => {
                const config = sceneConfigs[scene];
                const tag = document.createElement('span');
                tag.className = 'text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full';
                tag.textContent = config.name;
                display.appendChild(tag);
            });
        }

        // Generate Prompt with Claude API
        async function generatePrompt() {
            const userInput = document.getElementById('userInput').value.trim();
            
            // Validation
            if (state.selectedScenes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆæ›´ç²¾å‡†çš„æç¤ºè¯');
                return;
            }
            if (!userInput) {
                alert('è¯·è¾“å…¥ä½ çš„éœ€æ±‚æè¿°');
                return;
            }
            if (!state.apiKey) {
                showApiKeyModal();
                return;
            }

            // Show loading state
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('generateBtn').disabled = true;
            state.isGenerating = true;

            // Update loading steps
            const loadingSteps = [
                'æ­¥éª¤ 1/3: åˆ†ææ„å›¾åœºæ™¯...',
                'æ­¥éª¤ 2/3: æ„å»ºæç¤ºè¯ç»“æ„...',
                'æ­¥éª¤ 3/3: ä¼˜åŒ–è¡¨è¾¾æ–¹å¼...'
            ];
            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < loadingSteps.length - 1) {
                    stepIndex++;
                    document.getElementById('loadingStep').textContent = loadingSteps[stepIndex];
                }
            }, 1500);

            // Build system prompt based on selected scenes
            const sceneDescriptions = state.selectedScenes.map(s => sceneConfigs[s].name).join('ã€');
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·çš„æ¨¡ç³Šéœ€æ±‚è½¬åŒ–ä¸ºç»“æ„åŒ–ã€å¯æ‰§è¡Œçš„AIæç¤ºè¯ã€‚

ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯æ ‡ç­¾ï¼š${sceneDescriptions}

è¯·éµå¾ªä»¥ä¸‹åŸåˆ™ç”Ÿæˆæç¤ºè¯ï¼š
1. æ ¹æ®åœºæ™¯ç‰¹ç‚¹ï¼Œæ·»åŠ è¯¥åœºæ™¯ä¸‹æœ€æœ‰æ•ˆçš„æç¤ºè¯ç»“æ„å…ƒç´ 
2. ä½¿ç”¨æ˜ç¡®çš„è§’è‰²è®¾å®šã€ä»»åŠ¡æè¿°å’Œè¾“å‡ºæ ¼å¼è¦æ±‚
3. æ·»åŠ å¿…è¦çš„ä¸Šä¸‹æ–‡å’Œçº¦æŸæ¡ä»¶
4. å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ é€æ­¥æ€è€ƒæˆ–åˆ†æ­¥éª¤æ‰§è¡Œçš„æŒ‡ç¤º
5. ä½¿ç”¨Markdownæ ¼å¼ï¼Œè®©æç¤ºè¯æ˜“è¯»æ˜“ç”¨

ç”Ÿæˆçš„æç¤ºè¯åº”è¯¥ï¼š
- ç«‹å³å¯ç”¨äºAIå¯¹è¯
- æ— éœ€ç”¨æˆ·å†æ¬¡ä¿®æ”¹å³å¯äº§ç”Ÿé«˜è´¨é‡ç»“æœ
- åŒ…å«[æ–¹æ‹¬å·]æ ‡è®°çš„å¯è‡ªå®šä¹‰éƒ¨åˆ†`;

            // Prepare request body
            const requestBody = {
                model: "claude-opus-4-6",
                max_tokens: 2048,
                system: systemPrompt,
                messages: [
                    {
                        role: "user",
                        content: `è¯·å°†ä»¥ä¸‹éœ€æ±‚è½¬åŒ–ä¸ºç»“æ„åŒ–æç¤ºè¯ï¼š\n\n"${userInput}"\n\nåœºæ™¯ï¼š${sceneDescriptions}`
                    }
                ],
                stream: true
            };

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': state.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
                }

                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let buffer = '';

                clearInterval(stepInterval);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('generatedPrompt').textContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('event: ')) continue;
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'content_block_delta' && 
                                    parsed.delta?.type === 'text_delta') {
                                    fullResponse += parsed.delta.text;
                                    document.getElementById('generatedPrompt').textContent = fullResponse;
                                    // Auto-scroll to bottom
                                    document.getElementById('generatedPrompt').scrollTop = 
                                        document.getElementById('generatedPrompt').scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors for incomplete chunks
                            }
                        }
                    }
                }

                // Save generation to history
                saveGeneration(userInput, fullResponse, state.selectedScenes);

            } catch (error) {
                clearInterval(stepInterval);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('generateBtn').disabled = false;
                state.isGenerating = false;
                
                if (error.message.includes('authentication')) {
                    alert('API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥æˆ–é‡æ–°è®¾ç½®');
                    showApiKeyModal();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
                }
            }
        }

        // Save generation to local storage (Evolution Tracking)
        function saveGeneration(input, output, scenes) {
            const generation = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                input: input,
                output: output,
                scenes: scenes,
                inputHash: hashString(input) // Group similar inputs
            };

            state.generationHistory.unshift(generation);
            // Keep last 50 generations
            if (state.generationHistory.length > 50) {
                state.generationHistory = state.generationHistory.slice(0, 50);
            }
            
            localStorage.setItem('generation_history', JSON.stringify(state.generationHistory));
            state.currentGeneration = generation;
            
            updateEvolutionDisplay();
            updateStats();
        }

        // Simple hash function to group similar inputs
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Update Evolution Display (P1: Prompt Evolution Tracking)
        function updateEvolutionDisplay() {
            const list = document.getElementById('evolutionList');
            if (state.generationHistory.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">æš‚æ— è®°å½•ï¼Œå¼€å§‹ç”Ÿæˆä½ çš„ç¬¬ä¸€ä¸ªæç¤ºè¯å§ï¼</p>';
                return;
            }

            // Group by input hash (similar requests)
            const groups = {};
            state.generationHistory.forEach(gen => {
                if (!groups[gen.inputHash]) groups[gen.inputHash] = [];
                groups[gen.inputHash].push(gen);
            });

            // Show evolution for each group
            list.innerHTML = '';
            Object.entries(groups).slice(0, 5).forEach(([hash, gens]) => {
                const latest = gens[0];
                const sceneNames = latest.scenes.map(s => sceneConfigs[s]?.name || s).join('ã€');
                
                const item = document.createElement('div');
                item.className = 'history-item bg-white border rounded-xl p-3 cursor-pointer transition';
                item.onclick = () => loadGeneration(latest);
                
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-0.5 rounded">${sceneNames}</span>
                        <span class="text-xs text-gray-400">${formatTime(latest.timestamp)}</span>
                    </div>
                    <p class="text-sm text-gray-700 truncate">${latest.input}</p>
                    ${gens.length > 1 ? `<p class="text-xs text-green-600 mt-1">âœ¨ å·²ä¼˜åŒ– ${gens.length} æ¬¡</p>` : ''}
                `;
                
                list.appendChild(item);
            });
        }

        function updateStats() {
            document.getElementById('totalGenerations').textContent = state.generationHistory.length;
            
            // Calculate satisfaction from feedback
            const feedbacks = state.feedbackData;
            if (feedbacks.length > 0) {
                const positive = feedbacks.filter(f => f.type === 'up').length;
                const percentage = Math.round((positive / feedbacks.length) * 100);
                document.getElementById('avgSatisfaction').textContent = percentage + '%';
            } else {
                document.getElementById('avgSatisfaction').textContent = '--';
            }
            
            // Find favorite scene
            const sceneCounts = {};
            state.generationHistory.forEach(g => {
                g.scenes.forEach(s => {
                    sceneCounts[s] = (sceneCounts[s] || 0) + 1;
                });
            });
            const favorite = Object.entries(sceneCounts).sort((a, b) => b[1] - a[1])[0];
            if (favorite) {
                document.getElementById('favoriteScene').textContent = sceneConfigs[favorite[0]]?.name || favorite[0];
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diff = (now - date) / 1000; // seconds
            
            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
            return date.toLocaleDateString('zh-CN');
        }

        function loadGeneration(gen) {
            document.getElementById('userInput').value = gen.input;
            // Restore scene selection
            state.selectedScenes = gen.scenes;
            document.querySelectorAll('.scene-tag').forEach(tag => {
                const scene = tag.dataset.scene;
                if (gen.scenes.includes(scene)) {
                    tag.classList.add('tag-selected', 'border-purple-500');
                    tag.classList.remove('border-gray-200');
                } else {
                    tag.classList.remove('tag-selected', 'border-purple-500');
                    tag.classList.add('border-gray-200');
                }
            });
            updateSelectedScenesDisplay();
            
            // Show result
            document.getElementById('generatedPrompt').textContent = gen.output;
            document.getElementById('resultSection').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('resultSection').offsetTop - 100, behavior: 'smooth' });
        }

        // Feedback System (P0: Effect Feedback Loop)
        function submitFeedback(type) {
            if (!state.currentGeneration) return;
            
            // Show detail input
            document.getElementById('feedbackButtons').classList.add('hidden');
            document.getElementById('feedbackDetail').classList.remove('hidden');
            
            // Store preliminary feedback
            state.currentFeedback = {
                generationId: state.currentGeneration.id,
                type: type,
                timestamp: new Date().toISOString(),
                scenes: state.currentGeneration.scenes
            };
        }

        function submitFeedbackDetail() {
            const detail = document.getElementById('feedbackText').value.trim();
            
            if (state.currentFeedback) {
                state.currentFeedback.detail = detail;
                state.feedbackData.push(state.currentFeedback);
                localStorage.setItem('feedback_data', JSON.stringify(state.feedbackData));
            }
            
            document.getElementById('feedbackDetail').classList.add('hidden');
            document.getElementById('feedbackSuccess').classList.remove('hidden');
            
            updateStats();
            
            // Reset after delay
            setTimeout(() => {
                document.getElementById('feedbackSuccess').classList.add('hidden');
                document.getElementById('feedbackButtons').classList.remove('hidden');
                document.getElementById('feedbackText').value = '';
            }, 3000);
        }

        // Utility Functions
        function copyResult() {
            const text = document.getElementById('generatedPrompt').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        function regeneratePrompt() {
            generatePrompt();
        }
    </script>
</body>
</html>